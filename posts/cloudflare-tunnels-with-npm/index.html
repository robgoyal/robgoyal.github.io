<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Set up Cloudflare tunnels with Nginx Proxy Manager" /><meta name="author" content="Robin Goyal" /><meta property="og:locale" content="en" /><meta name="description" content="Recently, I learned about Cloudflare tunnels and how you can safely expose your internal services without opening any ports on your router and I was mindblown! In this post, I’ll show how to set up the Cloudflare tunnel, installing Docker services, using a wildcard subdomain to route all requests to NPM (Nginx Proxy Manager), and adding Google authentication to your applications." /><meta property="og:description" content="Recently, I learned about Cloudflare tunnels and how you can safely expose your internal services without opening any ports on your router and I was mindblown! In this post, I’ll show how to set up the Cloudflare tunnel, installing Docker services, using a wildcard subdomain to route all requests to NPM (Nginx Proxy Manager), and adding Google authentication to your applications." /><link rel="canonical" href="https://robgoyal.github.io/posts/cloudflare-tunnels-with-npm/" /><meta property="og:url" content="https://robgoyal.github.io/posts/cloudflare-tunnels-with-npm/" /><meta property="og:site_name" content="Robin Goyal" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-11T11:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Set up Cloudflare tunnels with Nginx Proxy Manager" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Robin Goyal"},"dateModified":"2023-03-11T11:00:00-05:00","datePublished":"2023-03-11T11:00:00-05:00","description":"Recently, I learned about Cloudflare tunnels and how you can safely expose your internal services without opening any ports on your router and I was mindblown! In this post, I’ll show how to set up the Cloudflare tunnel, installing Docker services, using a wildcard subdomain to route all requests to NPM (Nginx Proxy Manager), and adding Google authentication to your applications.","headline":"Set up Cloudflare tunnels with Nginx Proxy Manager","mainEntityOfPage":{"@type":"WebPage","@id":"https://robgoyal.github.io/posts/cloudflare-tunnels-with-npm/"},"url":"https://robgoyal.github.io/posts/cloudflare-tunnels-with-npm/"}</script><title>Set up Cloudflare tunnels with Nginx Proxy Manager | Robin Goyal</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Robin Goyal"><meta name="application-name" content="Robin Goyal"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profilepic.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Robin Goyal</a></div><div class="site-subtitle font-italic">Software Developer & Cybersecurity Enthusiast</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="/resume.pdf" aria-label="resume" class="order-3" > <i class="fas fa-file-alt"></i> </a> <a href="https://github.com/robgoyal" aria-label="github" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['robin.goyal.swd','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/robingoyal" aria-label="linkedin" class="order-6" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Set up Cloudflare tunnels with Nginx Proxy Manager</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Set up Cloudflare tunnels with Nginx Proxy Manager</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Robin Goyal </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Mar 11, 2023, 11:00 AM -0500" >Mar 11<i class="unloaded">2023-03-11T11:00:00-05:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3719 words">20 min read</span></div></div><div class="post-content"> <img data-proofer-ignore data-src="https://blog.cloudflare.com/content/images/2022/03/image1-106.png" class="preview-img" alt="Preview Image" ><p>Recently, I learned about Cloudflare tunnels and how you can safely expose your internal services without opening any ports on your router and I was mindblown! In this post, I’ll show how to set up the Cloudflare tunnel, installing Docker services, using a wildcard subdomain to route all requests to NPM (Nginx Proxy Manager), and adding Google authentication to your applications.</p><h1 id="why-cloudflare-tunnels">Why Cloudflare Tunnels</h1><p>One of the prerequisites to this tutorial is that you need to add a site to Cloudflare that you can manage. This will include many default features such as DDoS protection, malicious bots, and you can analyze stats for traffic directed to your website. Your domain does not need to be owned by Cloudflare but in my case, it is. If you have a domain elsewhere, the only steps should be to point your domain’s nameservers to Cloudflare’s nameservers but be sure to check their documentation. Lastly, everything in this tutorial is absolutely FREE!</p><p>Cloudflare tunnels are wicked because they will update your IP dynamically if it changes, encrypt all traffic, and include the above site protection features for your domain. There is a lot to it so let’s dive in.</p><h1 id="preparing-a-vm">Preparing a VM</h1><p>In my previous post, I documented how to create a VM in Proxmox. I will build off of that to prepare a VM that will install the cloudflared tunnel as well as NPM as a Docker container.</p><h2 id="install-packages">Install Packages</h2><p>First, we’ll run the following commands to help us out.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>apt update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt upgrade
<span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>apt <span class="nb">install </span>vim openssh-server
</pre></table></code></div></div><p>Next, let’s check the status of the SSH service to see if it was configured properly.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span>systemctl status sshd
<span class="go">● ssh.service - OpenBSD Secure Shell server
</span><span class="gp">     Loaded: loaded (/lib/systemd/system/ssh.service;</span><span class="w"> </span>enabled<span class="p">;</span> vendor preset:
<span class="gp">     Active: active (running) since Sat 2023-03-11 13:30:10 EST;</span><span class="w"> </span>3min 51s ago
<span class="go">       Docs: man:sshd(8)
             man:sshd_config(5)
   Main PID: 3959 (sshd)
      Tasks: 1 (limit: 3484)
     Memory: 2.6M
     CGroup: /system.slice/ssh.service
             └─3959 sshd: /usr/sbin/sshd -D [listener] 0 of 10-100 startups
</span></pre></table></code></div></div><h2 id="configure-a-static-ip">Configure a static IP</h2><p>The distribution I’m working with is an Ubuntu 20.04 instance which uses netplan for it’s network management. Netplan configuration files are saved in <code class="language-plaintext highlighter-rouge">/etc/netplan</code> and the only file I have is 01-network-manager-all.yaml</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">cat</span> /etc/netplan/01-network-manager-all.yaml
<span class="gp">#</span><span class="w"> </span>Let NetworkManager manage all devices on this system
<span class="go">network:
  version: 2
  renderer: NetworkManager
</span></pre></table></code></div></div><p>To update the configuration file, first, check the name of your interface.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span>ip <span class="nt">-br</span> a
<span class="go">lo               UNKNOWN        127.0.0.1/8 ::1/128
ens18            UP             192.168.0.X/24 2607:fea8:bddf:bc00::217c/128 2607:fea8:bddf:bc00:18f3:8fff:fee4:ebcd/64 fe80::18f3:8fff:fee4:ebcd/64
</span></pre></table></code></div></div><p>Update the configuration file similar to the contents below replacing the interface, IP address(es), the DNS servers, and the route to your gateway.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">cat</span> /etc/netplan/01-network-manager-all.yaml
<span class="gp">#</span><span class="w"> </span>Let NetworkManager manage all devices on this system
<span class="go">network:
  version: 2
  ethernets:
    ens18:
      dhcp4: false
      addresses: [192.168.0.X/24]
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
      routes:
        - to: default
          via: 192.168.0.1
</span></pre></table></code></div></div><p>Apply the netplan and check to see if the IP address was applied.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>netplan apply
<span class="gp">conductor@npm:~$</span><span class="w"> </span>ip <span class="nt">-br</span> a
<span class="go">lo               UNKNOWN        127.0.0.1/8 ::1/128
ens18            UP             192.168.0.X/24 2607:fea8:bddf:bc00::217c/128 2607:fea8:bddf:bc00:18f3:8fff:fee4:ebcd/64 fe80::18f3:8fff:fee4:ebcd/64
</span></pre></table></code></div></div><p>I usually reboot to see if the IP was persistent on reboot.</p><h2 id="install-docker">Install Docker</h2><h3 id="docker-repository-configuration">Docker Repository Configuration</h3><p>These instructions are from Docker <sup id="fnref:docker-install" role="doc-noteref"><a href="#fn:docker-install" class="footnote" rel="footnote">1</a></sup> but I will summarize them here.</p><p>Update the apt package index and install packages to allow apt to use a repository over HTTPS:</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>apt-get update
<span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>ca-certificates curl gnupg lsb-release
</pre></table></code></div></div><p>Add Docker’s official GPG key.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo mkdir</span> <span class="nt">-m</span> 0755 <span class="nt">-p</span> /etc/apt/keyrings
<span class="gp">conductor@npm:~$</span><span class="w"> </span>curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/docker.gpg
</pre></table></code></div></div><p>Set up the repository</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">echo</span> <span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu </span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null
</pre></table></code></div></div><h3 id="docker-package-installation">Docker Package Installation</h3><p>Update the package index with the new repositories that were added.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>apt-get update
</pre></table></code></div></div><p>Install Docker Engine, containerd, and Docker Compose.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
</pre></table></code></div></div><p>Verify that everything is working by pulling the hello-world image which is pretty much a container that Docker maintains to ensure your Docker installation is good to go.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>docker run hello-world
<span class="go">Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
2db29710123e: Pull complete
Digest: sha256:6e8b6f026e0b9c419ea0fd02d3905dd0952ad1feea67543f525c73a0a790fefb
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
</span><span class="gp"> $</span><span class="w"> </span>docker run <span class="nt">-it</span> ubuntu bash
<span class="go">
Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
</span></pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">-a</code> option will show all containers that are not running as well.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span>docker ps <span class="nt">-a</span>
<span class="go">CONTAINER ID   IMAGE         COMMAND    CREATED          STATUS                      PORTS     NAMES
144cb948ca3a   hello-world   "/hello"   28 seconds ago   Exited (0) 27 seconds ago             relaxed_aryabhata
</span></pre></table></code></div></div><h3 id="clean-up-the-container-and-image">Clean up the container and image</h3><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span>docker <span class="nb">rm </span>144cb94
<span class="go">144cb94
</span><span class="gp">conductor@npm:~$</span><span class="w"> </span>docker image <span class="nb">rm </span>hello-world
<span class="go">Untagged: hello-world:latest
Untagged: hello-world@sha256:6e8b6f026e0b9c419ea0fd02d3905dd0952ad1feea67543f525c73a0a790fefb
Deleted: sha256:feb5d9fea6a5e9606aa995e879d862b825965ba48de054caab5ef356dc6b3412
Deleted: sha256:e07ee1baac5fae6a26f30cabfe54a36d3402f96afda318fe0a96cec4ca393359
</span></pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">docker rm</code> command will accept the first few bytes of the Container ID.</p><h3 id="finishing-up">Finishing Up</h3><p>To wrap up the Docker installation, let’s enable the Docker and containerd service so that these services will start on boot.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker.service
<span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>systemctl <span class="nb">enable </span>containerd.service
</pre></table></code></div></div><p>Finally, all that should be left is to be able to manage the Docker installation as a non-root user <sup id="fnref:docker-post-install" role="doc-noteref"><a href="#fn:docker-post-install" class="footnote" rel="footnote">2</a></sup></p><p>Create the docker grou and add your user.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>groupadd docker
</pre></table></code></div></div><p>Add your user to the group.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>usermod <span class="nt">-aG</span> docker <span class="nv">$USER</span>
</pre></table></code></div></div><p>Activate the changes to the groups. Otherwise, you’ll have to log out and log back in.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span>newgrp docker
</pre></table></code></div></div><p>Feel free to pull the hello-world image to test if using the docker command without sudo works.</p><h1 id="install-cloudflared">Install Cloudflared</h1><p>On Cloudflare, enter the section to manage your site. Follow the below steps to create your first tunnel:</p><ol><li>Enter the dashboard to manage your site _&gt; select Access from the lefthand tabs -&gt; Launch Zero Trust -&gt; Expand the Access tab -&gt; Tunnels<li>Create a tunnel and provide a name for your tunnel<li>Install the connector. During my testing, I tried Docker and although it works, there was one annoying issue with the network namespace for the Docker container so I’m going to use the Debian installer.<li>Download the cloudflared debian package and install the service. Execute the three commands below replacing the JWT token with the one Cloudflare provided.</ol><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span>curl <span class="nt">-L</span> <span class="nt">--output</span> cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb <span class="o">&amp;&amp;</span>
<span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>dpkg <span class="nt">-i</span> cloudflared.deb <span class="o">&amp;&amp;</span>
<span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo </span>cloudflared service <span class="nb">install</span> &lt;JWT token&gt;
</pre></table></code></div></div><p>Once this command finishes executing, status at the bottom of the page should have a “Connected” status.</p><h1 id="install-nginx-proxy-manager">Install Nginx Proxy Manager</h1><p>Now, let’s install Nginx Proxy Manager and use the following docker-compose file to create our Docker container.</p><div lang="yaml" class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">app</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">jc21/nginx-proxy-manager:latest'</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="c1"># These ports are in format &lt;host-port&gt;:&lt;container-port&gt;</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">80:80'</span> <span class="c1"># Public HTTP Port</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">443:443'</span> <span class="c1"># Public HTTPS Port</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">81:81'</span> <span class="c1"># Admin Web Port</span>
      <span class="c1"># Add any other Stream port you want to expose</span>
      <span class="c1"># - '21:21' # FTP</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">DB_MYSQL_HOST</span><span class="pi">:</span> <span class="s2">"</span><span class="s">db"</span>
      <span class="na">DB_MYSQL_PORT</span><span class="pi">:</span> <span class="m">3306</span>
      <span class="na">DB_MYSQL_USER</span><span class="pi">:</span> <span class="s2">"</span><span class="s">npm"</span>
      <span class="na">DB_MYSQL_PASSWORD</span><span class="pi">:</span> <span class="s2">"</span><span class="s">npm"</span>
      <span class="na">DB_MYSQL_NAME</span><span class="pi">:</span> <span class="s2">"</span><span class="s">npm"</span>
      <span class="c1"># Uncomment this if IPv6 is not enabled on your host</span>
      <span class="c1"># DISABLE_IPV6: 'true'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./data:/data</span>
      <span class="pi">-</span> <span class="s">./letsencrypt:/etc/letsencrypt</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">db</span>

  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">jc21/mariadb-aria:latest'</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">MYSQL_ROOT_PASSWORD</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm'</span>
      <span class="na">MYSQL_DATABASE</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm'</span>
      <span class="na">MYSQL_USER</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm'</span>
      <span class="na">MYSQL_PASSWORD</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">./data/mysql:/var/lib/mysql</span>
</pre></table></code></div></div><p>The above is a standard file provided from the NPM website so let’s make a few changes. First, we’re going to change up some of the paths for the volumes and use a more secure password.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">sudo mkdir</span> <span class="nt">-p</span> /data/docker/<span class="o">{</span>npm,mysql<span class="o">}</span>
<span class="gp">conductor@npm:~$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span> /data/docker/
<span class="go">total 16
drwxr-xr-x 4 root root 4096 Mar 11 14:42 .
drwxr-xr-x 3 root root 4096 Mar 11 14:42 ..
drwxr-xr-x 2 root root 4096 Mar 11 14:42 mysql
drwxr-xr-x 2 root root 4096 Mar 11 14:42 npm
</span></pre></table></code></div></div><p>Our new configuration file.</p><div lang="yaml" class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">app</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">jc21/nginx-proxy-manager:latest'</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="c1"># These ports are in format &lt;host-port&gt;:&lt;container-port&gt;</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">80:80'</span> <span class="c1"># Public HTTP Port</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">443:443'</span> <span class="c1"># Public HTTPS Port</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">81:81'</span> <span class="c1"># Admin Web Port</span>
      <span class="c1"># Add any other Stream port you want to expose</span>
      <span class="c1"># - '21:21' # FTP</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">DB_MYSQL_HOST</span><span class="pi">:</span> <span class="s2">"</span><span class="s">db"</span>
      <span class="na">DB_MYSQL_PORT</span><span class="pi">:</span> <span class="m">3306</span>
      <span class="na">DB_MYSQL_USER</span><span class="pi">:</span> <span class="s2">"</span><span class="s">npm"</span>
      <span class="na">DB_MYSQL_PASSWORD</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;user</span><span class="nv"> </span><span class="s">password&gt;"</span>
      <span class="na">DB_MYSQL_NAME</span><span class="pi">:</span> <span class="s2">"</span><span class="s">npm"</span>
      <span class="c1"># Uncomment this if IPv6 is not enabled on your host</span>
      <span class="c1"># DISABLE_IPV6: 'true'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/data/docker/npm/data:/data</span>
      <span class="pi">-</span> <span class="s">/data/docker/npm/letsencrypt:/etc/letsencrypt</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">db</span>

  <span class="na">db</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">jc21/mariadb-aria:latest'</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="na">MYSQL_ROOT_PASSWORD</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;root</span><span class="nv"> </span><span class="s">password&gt;"</span>
      <span class="na">MYSQL_DATABASE</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm'</span>
      <span class="na">MYSQL_USER</span><span class="pi">:</span> <span class="s1">'</span><span class="s">npm'</span>
      <span class="na">MYSQL_PASSWORD</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;user</span><span class="nv"> </span><span class="s">password&gt;"</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/data/docker/mysql/mysql:/var/lib/mysql</span>
</pre></table></code></div></div><p>After saving the above file as docker-compose.yml, run the following</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">root@npm:/data/docker#</span><span class="w"> </span>docker compose up <span class="nt">-d</span>
</pre></table></code></div></div><p>After a few seconds, the containers should be started and we can verify that with the <code class="language-plaintext highlighter-rouge">docker ps</code> command.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="gp">conductor@npm:/data/docker$</span><span class="w"> </span>docker ps
<span class="go">CONTAINER ID   IMAGE                             COMMAND             CREATED              STATUS              PORTS                                                                                  NAMES
</span><span class="gp">9bb1dc81e49c   jc21/nginx-proxy-manager:latest   "/init"             About a minute ago   Up About a minute   0.0.0.0:80-81-&gt;</span>80-81/tcp, :::80-81-&gt;80-81/tcp, 0.0.0.0:443-&gt;443/tcp, :::443-&gt;443/tcp   docker-app-1
<span class="go">fe5074aaa88c   jc21/mariadb-aria:latest          "/scripts/run.sh"   About a minute ago   Up About a minute   3306/tcp                                                                               docker-db-1
</span></pre></table></code></div></div><p>If we browse to the IP address for the server that we’ve configured on port 81 (NPM admin panel), http://”&lt; IP &gt;”:81, we should see the login form.</p><p><img data-proofer-ignore data-src="/assets/img/posts/homelab-cloudflare-npm/npm-login.jpg" alt="NPM login" /></p><p>The default credentials are <code class="language-plaintext highlighter-rouge">admin@example.com:changeme</code>. Once you log in, you will be prompted to change it.</p><h1 id="cloudflare-tunnel---npm-integration">Cloudflare Tunnel -&gt; NPM Integration</h1><h2 id="create-a-public-hostname">Create a public hostname</h2><p>This is probably one of the most exciting moments that we can quickly test for our integration with Cloudflare Tunnel and NPM.</p><p>Switch back to the dashboard where you created your tunnel and add a public hostname (you can find this under the Public Hostnames tab).</p><ol><li>Create a public hostname<li>Subdomain: <code class="language-plaintext highlighter-rouge">npm</code><li>Select the domain which would be your domain/site that you’ve added to your Cloudflare account.<li>Service:<ol><li>Type: <code class="language-plaintext highlighter-rouge">http</code><li>Url: <code class="language-plaintext highlighter-rouge">127.0.0.1:81</code> (since Cloudflared and NPM are running on the same host, we can use localhost for this but if you have configured them to run on separate devices, use the IP address of your host).</ol><li>Leave the rest of the options as is.<li>Save hostname.</ol><p>We have gone through all of these steps just to end up at this final stage! Browse to <code class="language-plaintext highlighter-rouge">https://npm.&lt;your-domain&gt;</code> and you should be presented with the same login page that we saw above.</p><p>It is pretty amazing that with a few steps, we were able to access our Nginx Proxy Manager dashboard from outside of our home network with TLS encryption.</p><h2 id="self-signed-certificate-applications">Self-signed Certificate Applications</h2><p>For any applications that are self-signed, follow the above steps but select the Service Type as https and the URL as the <code class="language-plaintext highlighter-rouge">&lt;IP&gt;:&lt;HTTPS PORT&gt;</code>. Under Additional Application Settings, expand the TLS tab and enable No TLS Verify. The rest of the options should be the same.</p><p>If you have an application that has a Lets Encrypt cert for example, it should be fine.</p><h2 id="wildcard-subdomain-routing">Wildcard Subdomain Routing</h2><p>One of the cool things that I was able to get working was wildcard subdomain routing. What we will try to accomplish here is that for any subdomains that aren’t explicitly mentioned in the Tunnel’s Public Hostname tab, we will route through the NPM instance and then based on the hostname (including subdomain), NPM will proxy the requests to the hosts that we specify.</p><p><strong>Some notes about this</strong>:</p><ol><li>I learned this the hard way but the free tier does not allow Universal TLS encryption for nested subdomains (i.e you can’t have foo.bar.&lt; domain &gt;). Only one tier of subdomains is allowed.<li>You are able to control the order of the hostnames which I’m assuming is the resolution order so leave the wildcard routing at the bottom.<li><em>This was a bit of a challenge and a problem I will tackle in the future but this wildcard routing that I configure will only work for non-TLS supported applications. For any TLS applications, create an explicit entry in the Public Hostnames page that routes to your server similar to how I mentioned above.</em></ol><p>In the public hostname page, follow the same steps as mentioned earlier when we were creating the <code class="language-plaintext highlighter-rouge">npm</code> subdomain to create a wildcard subdomain entry. The only differences are that for the subdomain use <code class="language-plaintext highlighter-rouge">*</code> and the URL will stay as the IP for your NPM server and the port should now be 80 instead of 81. Port 81 is used for NPM administration whereas port 80 and 443 is where the proxying is enabled.</p><p>There is still one more crucial step for this to work. Head to the Overview tab for your tunnel and copy the tunnel ID. It should be a long alphanumeric string separated with dashes. Exit out of the Zero Trust dashboard and click on the DNS tab for your site/domain’s section.</p><p>Create a CNAME DNS record with <code class="language-plaintext highlighter-rouge">*</code> as the Name and the Content is <code class="language-plaintext highlighter-rouge">&lt;tunnel id&gt;.cfargotunnel.com</code> and leave the Proxy status as Proxied and not DNS only. We should be all set to enable wildcard routing through our NPM instance.</p><h3 id="create-an-npm-proxy-host">Create an NPM Proxy Host</h3><p>If you followed this tutorial, you should have two subdomains in your Public Hostnames section for your Cloudflare tunnel. One is for <code class="language-plaintext highlighter-rouge">npm</code> and the other is for <code class="language-plaintext highlighter-rouge">*</code> (wildcard). Let’s delete the <code class="language-plaintext highlighter-rouge">npm</code> entry and actually enable this in our Nginx Proxy Manager dashboard as a Proxy Host. If this sounds confusing, I will document the steps and explain along the way.</p><p>First, head to the NPM admin panel through your local IP address and not through the <code class="language-plaintext highlighter-rouge">npm</code> subdomain since we just deleted it, and Add a Proxy Host.</p><p>For the settings,</p><ul><li>Domain names: <code class="language-plaintext highlighter-rouge">npm.&lt;domain&gt;</code><li>Scheme: <code class="language-plaintext highlighter-rouge">http</code><li>Forward Hostname/IP: <code class="language-plaintext highlighter-rouge">127.0.0.1</code><li>Forward Port: <code class="language-plaintext highlighter-rouge">81</code><li>Select Block Common Exploits</ul><p>Leave the rest of the settings as is.</p><p>What we are saying here is that if the NPM receives a request for a host with the <code class="language-plaintext highlighter-rouge">npm</code> subdomain on port 80, proxy the request to the same NPM instance but on port 81. This process should work perfectly since we configured Cloudflare tunnels to route all wildcard requests to the NPM server on port 80. Now, we can perform the same request as before to <code class="language-plaintext highlighter-rouge">https://npm.&lt;domain&gt;</code> and be redirected to our NPM admin page.</p><h3 id="additional-npm-proxy-hosts">Additional NPM Proxy Hosts</h3><h4 id="portainer">Portainer</h4><p>To demonstrate this point further, let’s install Portainer as an application as well. Portainer is a Docker image that will provide an administrative panel to manage all of your Docker instances locally or connect to Portainer agents and manage those Docker instances as well. If you don’t have another server, feel free to install it locally on the same Docker instance as your NPM/Cloudflared server, but keep in mind that the IP addresses and details might differ slightly.</p><p>I saved the following Docker compose file as portainer-docker-compose.yml. Make changes as you see necessary.</p><div lang="yaml" class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">portainer</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">portainer/portainer-ce:latest</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">portainer</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
    <span class="na">security_opt</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">no-new-privileges:true</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/etc/localtime:/etc/localtime:ro</span>
      <span class="pi">-</span> <span class="s">/var/run/docker.sock:/var/run/docker.sock</span>
      <span class="pi">-</span> <span class="s">/data/docker/portainer:/data</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">9000:9000</span>
</pre></table></code></div></div><p>Run the following command:</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">conductor@docker:~$</span><span class="w"> </span>docker compose <span class="nt">-f</span> portainer-docker-compose.yml up <span class="nt">-d</span>
</pre></table></code></div></div><p>Browse to <code class="language-plaintext highlighter-rouge">http://&lt;ip&gt;:9000</code> and Portainer should prompt you to create an account. Once you create an account, select the local tab on the left, and you can view the containers running on this Docker instance. If you have more than just portainer running, you’ll see all of your containers.</p><p><img data-proofer-ignore data-src="/assets/img/posts/homelab-cloudflare-npm/portainer-dashboard.jpg" alt="portainer admin" /></p><p>Next, let’s create another NPM Proxy Host in the NPM dashboard with the following settings.</p><p>For the settings,</p><ul><li>Domain names: <code class="language-plaintext highlighter-rouge">portainer.&lt;domain&gt;</code><li>Scheme: <code class="language-plaintext highlighter-rouge">http</code><li>Forward Hostname/IP: <code class="language-plaintext highlighter-rouge">&lt;IP&gt;</code><li>Forward Port: <code class="language-plaintext highlighter-rouge">9000</code><li>Select Block Common Exploits</ul><p>Leave the rest of the settings as is. Now, if you browse to <code class="language-plaintext highlighter-rouge">portainer.&lt;domain&gt;</code>, you can finally access your application outside of your local environment!</p><h4 id="vs-code-server">VS Code Server</h4><p>Even for fun, let’s download the VS Code Server Docker container which renders VS code in the browser!</p><p>Let’s copy the sample docker-compose file from https://hub.docker.com/r/linuxserver/code-server and modify the settings a bit.</p><div lang="yaml" class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2.1"</span>
<span class="na">services</span><span class="pi">:</span>
  <span class="na">code-server</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">lscr.io/linuxserver/code-server:latest</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">code-server</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">PUID=1000</span>
      <span class="pi">-</span> <span class="s">PGID=1000</span>
      <span class="pi">-</span> <span class="s">TZ=Etc/UTC</span>
      <span class="pi">-</span> <span class="s">PASSWORD=&lt;password&gt;</span>
      <span class="pi">-</span> <span class="s">SUDO_PASSWORD=&lt;sudo password&gt;</span>
      <span class="pi">-</span> <span class="s">DEFAULT_WORKSPACE=/config/workspace</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/data/docker/vscode/config:/config</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">8443:8443</span>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">unless-stopped</span>
</pre></table></code></div></div><p>Same as before, I saved this as vs-code-docker-compose.yml and ran the docker compose command.</p><div lang="console" class="language-console highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="gp">conductor@docker:~$</span><span class="w"> </span>docker compose <span class="nt">-f</span> vs-code-docker-compose.yml up <span class="nt">-d</span>
</pre></table></code></div></div><p>Once the Docker container has finished, we should be able to view it by browsing to <code class="language-plaintext highlighter-rouge">http://&lt;IP&gt;:8443</code> and entering our password that we specified in the <code class="language-plaintext highlighter-rouge">PASSWORD</code> environment variable in the docker compose file.</p><p>Next, the container should appear in portainer as well where we can manage any changes from there.</p><p>All that’s left is to add another proxy host to the NPM instance that routes the <code class="language-plaintext highlighter-rouge">vscode</code> subdomain to the VS Code Server on port 8443. <strong>The only addition when adding this proxy host is to Enable Websockets Support and that should be it.</strong></p><p>It is pretty awesome that we were able to set this up with such little effort. Feel free to keep adding subdomains through the tunnel page or through NPM. For now, I will be adding proxy hosts in the NPM home page as long as they don’t have TLS enabled and then for any TLS applications, those will be explicit entries through the Tunnels dashboard.</p><h2 id="npm-404-not-found">NPM 404 Not Found</h2><p>Since all of our requests that don’t match explicit subdomains from the tunnels specification are going through NPM, we should specify a 404 page. The default is that NPM will display a congratulations page.</p><p>Under the settings tab, edit the Default Site setting and create a Custom Page with the following HTML.</p><div lang="html" class="language-html highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;&lt;title&gt;</span>404 Not Found<span class="nt">&lt;/title&gt;&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;center&gt;&lt;h1&gt;</span>404 Not Found<span class="nt">&lt;/h1&gt;&lt;/center&gt;</span>
<span class="nt">&lt;hr&gt;&lt;/hr&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
<span class="c">&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;</span>
<span class="c">&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;</span>
<span class="c">&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;</span>
<span class="c">&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;</span>
<span class="c">&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;</span>
<span class="c">&lt;!-- a padding to disable MSIE and Chrome friendly error page --&gt;</span>
</pre></table></code></div></div><p>Now, if we browse to <code class="language-plaintext highlighter-rouge">fake.&lt;domain&gt;</code>, we should presented with just a 404 Not Found page with no details about what type of NGINX server it is. The default 404 page includes the version of NGINX and returns an HTTP status code of 404. I’m sure that Cloudflare has some safeguards against attacks but let’s keep our attackers on their toes.</p><h1 id="cloudflare-access">Cloudflare Access</h1><p>Lastly, Cloudflare Access has a versatile range of authentication methods that you can place in front of any of your applications. This can be configured with include policies, exclude policies, with a diverse number of methods to specify selectors such as emails, IP ranges, domains, etc. It is possible to apply this to a wildcard subdomain if you want to block absolutely everything but I will apply this per subdomain application since I might want to expose some for hosting my own blog, etc.</p><h2 id="google-identity-provider-integration">Google Identity Provider Integration</h2><p>Follow the steps here <sup id="fnref:google-idp" role="doc-noteref"><a href="#fn:google-idp" class="footnote" rel="footnote">3</a></sup> to enable Google authentication with Cloudflare Access.</p><h3 id="cloudflare-access-group">Cloudflare Access Group</h3><p>Once the above is configured, select Access Groups under the Access dropdown. I am going to create an Access Group to enable my personal emails using Google authentication.</p><ol><li>Specify a Group name.<li>Check off Default Group<li>For the Include policy<ol><li>Selector: <code class="language-plaintext highlighter-rouge">Emails</code><li>Value: You can include multiple emails, just press enter between each one.</ol><li>Save.</ol><h3 id="couldflare-access-application">Couldflare Access Application</h3><p>Let’s create our first Access Application. Head to Applications under the Access dropdown.</p><ol><li>Select Self-Hosted.<li>Specify an Application name<li>Update the Session Duration to what you’re comfortable with. This will invalidate after the amount of time and reprompt you for the Google authentication method.<li>Specify the application subdomain (use a wildcard if you want to apply this to every application) and the domain<li>Under Identity providers, I unchecked Accept all and selected Google. Click Next.<li>Provide a policy name. Leave the rest of the options as default and proceed to the next page.<li>Same here. Leave the rest of the options as default and Add application.</ol><p>In an incognito browser, browse to one of the subdomains that match the application you created.</p><p><img data-proofer-ignore data-src="/assets/img/posts/homelab-cloudflare-npm/google-auth.jpg" alt="google auth" /></p><p>You’ll be presented with a Cloudflare access page and a button that will direct you to use Google’s authentication methods. If you use an email that doesn’t match the emails in the Access Group include policy you created, then you’ll be denied access.</p><p><img data-proofer-ignore data-src="/assets/img/posts/homelab-cloudflare-npm/google-denied.jpg" alt="google denied" /></p><p>If you successfully authenticate with a matching email, you will be allowed access! And there we have it. That wasn’t as complicated as we thought and it is pretty amazing how seamlessly everything works.</p><p><em>One thing to note is that once you’re authenticated through Google, this session will persist across multiple applications.</em></p><h1 id="conclusion">Conclusion</h1><p>The Cloudflare Zero Trust service is impressive and I have only scratched the surface of what’s possible. It doesn’t support just HTTP and HTTPS applications, it can also render SSH, RDP, and support arbitrary TCP protocols. Lastly, it can even render SSH and VNC applications in the browser. In future posts, I will document those as well but I think we’ve covered enough here.</p><h1 id="references">References</h1><div class="footnotes" role="doc-endnotes"><ol><li id="fn:docker-install" role="doc-endnote"><p><a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a> <a href="#fnref:docker-install" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:docker-post-install" role="doc-endnote"><p><a href="https://docs.docker.com/engine/install/linux-postinstall/">https://docs.docker.com/engine/install/linux-postinstall/</a> <a href="#fnref:docker-post-install" class="reversefootnote" role="doc-backlink">&#8617;</a></p><li id="fn:google-idp" role="doc-endnote"><p><a href="https://developers.cloudflare.com/cloudflare-one/identity/idp-integration/google/">https://developers.cloudflare.com/cloudflare-one/identity/idp-integration/google/</a> <a href="#fnref:google-idp" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/homelab/'>Homelab</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Set up Cloudflare tunnels with Nginx Proxy Manager - Robin Goyal&url=https://robgoyal.github.io/posts/cloudflare-tunnels-with-npm/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Set up Cloudflare tunnels with Nginx Proxy Manager - Robin Goyal&u=https://robgoyal.github.io/posts/cloudflare-tunnels-with-npm/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://robgoyal.github.io/posts/cloudflare-tunnels-with-npm/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/configure-raspberry-pi-from-scratch/">Configure a Raspberry Pi from scratch</a><li><a href="/posts/pbs-rpi/">Proxmox Backup Server on Raspberry Pi</a><li><a href="/posts/thm-basic-pentesting/">Basic Pentesting (Try Hack Me)</a><li><a href="/posts/thm-gamezone/">Gamezone (Try Hack Me)</a><li><a href="/posts/thm-overpass/">Overpass (Try Hack Me)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/thm/">thm</a> <a class="post-tag" href="/tags/privesc/">privesc</a> <a class="post-tag" href="/tags/web-application/">web application</a> <a class="post-tag" href="/tags/ejpt/">eJPT</a> <a class="post-tag" href="/tags/ftp/">ftp</a> <a class="post-tag" href="/tags/reverse-shell/">reverse shell</a> <a class="post-tag" href="/tags/brute-force/">brute force</a> <a class="post-tag" href="/tags/ine/">INE</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/configure-raspberry-pi-from-scratch/"><div class="card-body"> <span class="timeago small" >Nov 12, 2022<i class="unloaded">2022-11-12T11:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configure a Raspberry Pi from scratch</h3><div class="text-muted small"><p> Earlier this year, I converted my old desktop into a Proxmox server (you’re probably wondering why I’m talking about Proxmox on a post discussing the Raspberry Pi but we’ll get there) in an effort ...</p></div></div></a></div><div class="card"> <a href="/posts/pbs-rpi/"><div class="card-body"> <span class="timeago small" >Nov 13, 2022<i class="unloaded">2022-11-13T13:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Proxmox Backup Server on Raspberry Pi</h3><div class="text-muted small"><p> This is my second post in a series of blog posts (in no particular order) to build my homelab. These posts and this homelab will be a living being connected to myself. As I grow and learn more abou...</p></div></div></a></div><div class="card"> <a href="/posts/create-vm-proxmox/"><div class="card-body"> <span class="timeago small" >Mar 1<i class="unloaded">2023-03-01T14:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Creating my first Linux VM in Proxmox</h3><div class="text-muted small"><p> It’s been a few months since I have worked on my home lab but after learning about Cloudflare Tunnels, it has reinvigorated the youth in me to tackle this problem again. Over the next couple of blo...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/create-vm-proxmox/" class="btn btn-outline-primary" prompt="Older"><p>Creating my first Linux VM in Proxmox</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://github.com/robgoyal">Robin Goyal</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/writeup/">writeup</a> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/thm/">thm</a> <a class="post-tag" href="/tags/privesc/">privesc</a> <a class="post-tag" href="/tags/web-application/">web application</a> <a class="post-tag" href="/tags/ejpt/">eJPT</a> <a class="post-tag" href="/tags/ftp/">ftp</a> <a class="post-tag" href="/tags/reverse-shell/">reverse shell</a> <a class="post-tag" href="/tags/brute-force/">brute force</a> <a class="post-tag" href="/tags/ine/">INE</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://robgoyal.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
